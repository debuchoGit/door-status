<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Door Status</title>
<style>
  body{
    margin:0;
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
  }
  #statusBox{
    font-size:80px;
    font-weight:900;
    text-align:center;
    padding:0 16px;
  }
</style>
</head>

<body>
<div id="statusBox">読み込み中...</div>

<script>
  const OWNER = "debuchoGit";
  const REPO  = "door-status";
  const PATH  = "Status.txt";
  const BRANCH = "main";

  // sha取得用（キャッシュ無視のためt付けてる）
  const API_URL = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${BRANCH}`;

  function applyStyle(text){
    const box = document.getElementById("statusBox");
    box.textContent = text || "（未設定）";

    switch(text){
      case "入室可":
        document.body.style.backgroundColor = "#E3FCE3";
        box.style.color = "#000";
        break;
      case "会議中":
        document.body.style.backgroundColor = "#FF4B4B";
        box.style.color = "#FFF";
        break;
      case "電話中":
        document.body.style.backgroundColor = "#FFDD55";
        box.style.color = "#000";
        break;
      case "作業中":
        document.body.style.backgroundColor = "#87CEFA";
        box.style.color = "#000";
        break;
      case "外出中":
        document.body.style.backgroundColor = "#A8A8A8";
        box.style.color = "#000";
        break;
      case "不在":
        document.body.style.backgroundColor = "#555555";
        box.style.color = "#FFF";
        break;
      default:
        document.body.style.backgroundColor = "#FFFFFF";
        box.style.color = "#000";
    }
  }

  async function update(){
    try{
      // 1) APIから最新shaを取得
      const apiRes = await fetch(API_URL + "&t=" + Date.now(), { cache: "no-store" });
      if(!apiRes.ok) throw new Error("API HTTP " + apiRes.status);

      const meta = await apiRes.json();
      const sha = meta.sha;
      if(!sha) throw new Error("shaが取得できない");

      // 2) sha入りURLでStatus.txtを取得（URL自体が変わるのでキャッシュに強い）
      const rawBySha = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${sha}/${PATH}`;
      const res = await fetch(rawBySha, { cache: "no-store" });
      if(!res.ok) throw new Error("RAW HTTP " + res.status);

      const text = (await res.text()).trim();
      applyStyle(text);

    } catch (e) {
      const box = document.getElementById("statusBox");
      box.textContent = "通信エラー: " + e;
      document.body.style.backgroundColor = "#000";
      box.style.color = "#fff";
    }
  }

  update();
  setInterval(update, 15000); // 15秒ごと（API制限回避）
</script>
</body>
</html>
